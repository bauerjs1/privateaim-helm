apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ .Release.Name }}-hub-server-core"
  labels:
    app: "{{ .Release.Name }}-hub-server-core"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "{{ .Release.Name }}-hub-server-core"
  template:
    metadata:
      name: "{{ .Release.Name }}-hub-server-core"
      labels:
        app: "{{ .Release.Name }}-hub-server-core"
    spec:
      restartPolicy: Always
      initContainers:
          -   name: wait-for-db
              image: busybox
              command: [
                  'sh',
                  '-c',
                  'until nc -z -v -w30 {{ .Release.Name }}-hub-mysql-primary 3306; do echo "Waiting for db..."; sleep 5; done'
              ]
          -   name: wait-for-redis
              image: busybox
              command: [
                  'sh',
                  '-c',
                  'until nc -z -v -w30 {{ .Release.Name }}-hub-redis-master 6379; do echo "Waiting for redis..."; sleep 5; done'
              ]
          -   name: wait-for-rabbitmq
              image: busybox
              command: [
                  'sh',
                  '-c',
                  'until nc -z -v -w30 {{ .Release.Name }}-hub-rabbitmq 5672; do echo "Waiting for rabbitmq..."; sleep 5; done'
              ]
          -   name: wait-for-vault
              image: busybox
              command: [
                  'sh',
                  '-c',
                  'until nc -z -v -w30 {{ .Release.Name }}-vault 8200; do echo "Waiting for vault..."; sleep 5; done'
              ]
          -   name: wait-for-authup
              image: busybox
              command: [
                  'sh',
                  '-c',
                  'until nc -z -v -w30 {{ .Release.Name }}-authup-server-core 3000; do echo "Waiting for authup..."; sleep 5; done'
              ]
      containers:
        - name: "{{ .Release.Name }}-hub-server-core"
          image: "ghcr.io/privateaim/hub:latest"
          imagePullPolicy: Always
          ports:
            - containerPort: 3000
              protocol: TCP
          env:
              -   name: REDIS_CONNECTION_STRING
                  value: "redis://default:{{ .Values.global.redis.password }}@{{ .Release.Name }}-hub-redis-master"
              -   name: VAULT_CONNECTION_STRING
                  value: "start123@http://{{ .Release.Name }}-vault:8200/v1/"
              -   name: RABBITMQ_CONNECTION_STRING
                  value: "amqp://root:start123@{{ .Release.Name }}-hub-rabbitmq"
              -   name: AUTHUP_URL
                  value: "http://{{ .Release.Name }}-authup-server-core:3000/"
              -   name: SKIP_PROJECT_APPROVAL
                  value: "true"
              -   name: SKIP_ANALYSIS_APPROVAL
                  value: "true"
              -   name: DB_TYPE
                  value: "{{- include "db.type" .Subcharts.shared | trim }}"
              -   name: DB_HOST
                  value: "{{- include "db.host" .Subcharts.shared | trim }}"
              -   name: DB_USERNAME
                  value: "{{- include "db.user" .Subcharts.shared | trim }}"
              -   name: DB_PASSWORD
                  value: "{{- include "db.password" .Subcharts.shared | trim }}"
              -   name: DB_DATABASE
                  value: "{{- include "db.database" .Subcharts.shared | trim }}"
          resources:
              requests:
                  memory: "512Mi"
              limits:
                  memory: "2048Mi"
          readinessProbe:
              httpGet:
                  path: "/"
                  port: 3000
              initialDelaySeconds: 60
              periodSeconds: 5
              timeoutSeconds: 10
          livenessProbe:
              httpGet:
                  path: "/"
                  port: 3000
              periodSeconds: 10
              timeoutSeconds: 10


